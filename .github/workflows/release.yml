name: New release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version in x.y.z format"
        required: true
        type: string
      ticket:
        description: "Ticket ID for PR title, e.g. DEMRUM-1234"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: ${{ inputs.version }}. Must be x.y.z"
            exit 1
          fi

      - name: Validate ticket
        run: |
          if [[ ! "${{ inputs.ticket }}" =~ ^DEMRUM-[0-9]+$ ]]; then
            echo "Invalid ticket format: ${{ inputs.ticket }}. Must be DEMRUM-xxxx"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      # No need for SSH/GPG setup; create-pull-request will sign commits itself.

      - name: Update CHANGELOG.md header
        run: |
          DATE=$(date +%Y-%m-%d)
          sed -i "/^## \[Unreleased\]/a\\
          \\
          ## [${{ inputs.version }}] - $DATE" CHANGELOG.md

      - name: Bump version in SplunkRum.swift
        run: |
          FILE="SplunkAgent/Sources/SplunkAgent/Public API/SplunkRum.swift"
          sed -i -E "s/(public[[:space:]]+static[[:space:]]+let[[:space:]]+version[[:space:]]*=[[:space:]]*\")([0-9]+\.[0-9]+\.[0-9]+)(\")/\1${{ inputs.version }}\3/" "$FILE"

      - name: Add version to bug template
        run: |
          TARGET_FILE=".github/ISSUE_TEMPLATE/bug.yml"
          if [ ! -f "$TARGET_FILE" ]; then
            echo "Error: $TARGET_FILE not found"
            exit 1
          fi
          if grep -qE "^[[:space:]]*-[[:space:]]${{ inputs.version }}$" "$TARGET_FILE"; then
            echo "Warning: Version ${{ inputs.version }} already present"
            exit 0
          fi
          TMP="$(mktemp)"
          awk -v ver="${{ inputs.version }}" '
            BEGIN{in_dd=0; in_cv=0; in_opts=0; inserted=0}
            /^[[:space:]]*- type: dropdown[[:space:]]*$/ {in_dd=1}
            in_dd && /^[[:space:]]*id:[[:space:]]*(client-version|agent-version)[[:space:]]*$/ {in_cv=1}
            in_cv && /^[[:space:]]*options:[[:space:]]*$/ {print; printf "        - %s\n", ver; inserted=1; in_opts=1; next}
            /^- type:[[:space:]]/ {in_dd=0; in_cv=0; in_opts=0}
            {print}
            END{if(!inserted){exit 2}}
          ' "$TARGET_FILE" > "$TMP" || true
          if [ -s "$TMP" ]; then
            mv "$TMP" "$TARGET_FILE"
            echo "Inserted ${{ inputs.version }} into $TARGET_FILE"
          else
            echo "Error: Could not locate dropdown options to insert version in $TARGET_FILE"
            exit 1
          fi

      - name: Extract PR body from CHANGELOG
        id: prbody
        run: |
          BODY="$(
            awk -v ver="${{ inputs.version }}" '
              $0 ~ "^##[[:space:]]+\\["ver"\\]" {print; p=1; next}
              /^##[[:space:]]/ && p {exit}
              p {print}
            ' CHANGELOG.md
          )"
          printf "%s\n" "$BODY" > pr_body.md

      - name: Create Pull Request (signed commit)
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          # Signs commits as github-actions[bot] (with GITHUB_TOKEN) or as your app if you use a GitHub App token.
          sign-commits: true
          commit-message: "${{ inputs.ticket }}: Prepare ${{ inputs.version }} version"
          title: "${{ inputs.ticket }}: Release ${{ inputs.version }}"
          body-path: pr_body.md
          branch: "release/${{ inputs.version }}"
          base: main
          # Optional: limit committed paths if you want to be strict
          # add-paths: |
          #   CHANGELOG.md
          #   SplunkAgent/Sources/SplunkAgent/Public API/SplunkRum.swift
          #   .github/ISSUE_TEMPLATE/bug.yml

      - name: Show PR URL and verification status
        if: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          echo "PR: ${{ steps.cpr.outputs.pull-request-url }}"
          echo "Commits verified: ${{ steps.cpr.outputs['pull-request-commits-verified'] }}"
