name: New release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version in x.y.z format"
        required: true
        type: string
      ticket:
        description: "Ticket ID for PR title, e.g. DEMRUM-1234"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Validate version
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid version format: ${{ inputs.version }}. Must be x.y.z"
            exit 1
          fi

      - name: Validate ticket
        run: |
          if [[ ! "${{ inputs.ticket }}" =~ ^DEMRUM-[0-9]+$ ]]; then
            echo "Invalid ticket format: ${{ inputs.ticket }}. Must be DEMRUM-xxxx"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v6

      - name: Create release branch
        run: |
          BRANCH="release/${{ inputs.version }}"
          git switch -c "$BRANCH"
          git push -u origin "$BRANCH"
          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Update CHANGELOG.md header
        run: |
          DATE=$(date +%Y-%m-%d)
          sed -i "/^## \[Unreleased\]/a\\
          \\
          ## [${{ inputs.version }}] - $DATE" CHANGELOG.md
          git add CHANGELOG.md

      - name: Bump version in SplunkRum.swift
        run: |
          FILE="SplunkAgent/Sources/SplunkAgent/Public API/SplunkRum.swift"
          sed -i -E "s/(public[[:space:]]+static[[:space:]]+let[[:space:]]+version[[:space:]]*=[[:space:]]*\")([0-9]+\.[0-9]+\.[0-9]+)(\")/\1${{ inputs.version }}\3/" "$FILE"
          git add "$FILE"

      - name: Add version to bug template
        run: |
          TARGET_FILE=".github/ISSUE_TEMPLATE/bug.yml"
          if [ ! -f "$TARGET_FILE" ]; then
            echo "Error: $TARGET_FILE not found"
            exit 1
          fi
          if grep -qE "^[[:space:]]*-[[:space:]]${{ inputs.version }}$" "$TARGET_FILE"; then
            echo "Warning: Version ${{ inputs.version }} already present"
            exit 0
          fi
          TMP="$(mktemp)"
          awk -v ver="${{ inputs.version }}" '
            BEGIN{in_dd=0; in_cv=0; in_opts=0; inserted=0}
            /^[[:space:]]*- type: dropdown[[:space:]]*$/ {in_dd=1}
            in_dd && /^[[:space:]]*id:[[:space:]]*(client-version|agent-version)[[:space:]]*$/ {in_cv=1}
            in_cv && /^[[:space:]]*options:[[:space:]]*$/ {print; printf "        - %s\n", ver; inserted=1; in_opts=1; next}
            /^- type:[[:space:]]/ {in_dd=0; in_cv=0; in_opts=0}
            {print}
            END{if(!inserted){exit 2}}
          ' "$TARGET_FILE" > "$TMP" || true
          if [ -s "$TMP" ]; then
            mv "$TMP" "$TARGET_FILE"
            git add "$TARGET_FILE"
            echo "Inserted ${{ inputs.version }} into $TARGET_FILE"
          else
            echo "Error: Could not locate dropdown options to insert version in $TARGET_FILE"
            exit 1
          fi


      - name: Create signed commit via GitHub API
        uses: actions/github-script@v8
        with:
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            const path = require('path');

            const branch = process.env.BRANCH;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get current branch SHA
            const { data: refData } = await github.rest.git.getRef({
              owner,
              repo,
              ref: `heads/${branch}`
            });
            const currentSha = refData.object.sha;

            // Get current commit to get tree
            const { data: currentCommit } = await github.rest.git.getCommit({
              owner,
              repo,
              commit_sha: currentSha
            });

            // Get all changed files
            const changedFiles = execSync('git diff --name-only HEAD', { encoding: 'utf-8' })
              .trim()
              .split('\n')
              .filter(f => f);

            // Create blobs for all changed files
            const blobs = [];
            for (const file of changedFiles) {
              const content = fs.readFileSync(file, { encoding: 'base64' });
              const { data: blob } = await github.rest.git.createBlob({
                owner,
                repo,
                content,
                encoding: 'base64'
              });
              blobs.push({
                path: file,
                mode: '100644',
                type: 'blob',
                sha: blob.sha
              });
            }

            // Create new tree
            const { data: newTree } = await github.rest.git.createTree({
              owner,
              repo,
              base_tree: currentCommit.tree.sha,
              tree: blobs
            });

            // Create commit (GitHub will sign it)
            const { data: newCommit } = await github.rest.git.createCommit({
              owner,
              repo,
              message: `${{ inputs.ticket }}: Prepare ${{ inputs.version }} version`,
              tree: newTree.sha,
              parents: [currentSha]
            });

            // Update branch reference
            await github.rest.git.updateRef({
              owner,
              repo,
              ref: `heads/${branch}`,
              sha: newCommit.sha
            });

            console.log(`âœ… Created signed commit: ${newCommit.sha}`);

      - name: Create PR to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY="$(
            awk -v ver="${{ inputs.version }}" '
              $0 ~ "^##[[:space:]]+\\["ver"\\]" {print; p=1; next}
              /^##[[:space:]]/ && p {exit}
              p {print}
            ' CHANGELOG.md
          )"

          PR_URL=$(gh pr create \
            --title "${{ inputs.ticket }}: Release ${{ inputs.version }}" \
            --base main \
            --head "${{ env.BRANCH }}" \
            --body "$BODY" \
            --draft)

          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"
          echo "Created draft PR $PR_URL"

      - name: Mark PR as ready
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr ready "${{ env.PR_URL }}"
