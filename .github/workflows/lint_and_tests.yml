name: Lint & Tests

on:
  push: 
#     branches: [ main ]
#   pull_request:
#       types: [opened, edited, reopened, synchronize]

jobs:
  lint:
    name: Lint
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install SwiftLint
        run: |
          brew update
          brew install swiftlint

      - name: SwiftLint
        run: |
            for dir in $(find . -maxdepth 1 -type d -name "Splunk*"); do
                echo "Start Linting $dir"
                (
                    cd "$dir"
                    swiftlint lint \
                        --config ../Tools/.swiftlint.yml \
                        --reporter github-actions-logging \
                        --force-exclude || {
                          code=$?
                          if [ $code -eq 1 ]; then
                            echo "No Swift files found in $dir, skipping"
                          else
                            exit $code
                          fi
                        }
                    cd ..
                )
            done

  tests:
    name: Tests
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
#        platform: [ ios, tvos, visionos, maccatalyst ]
        platform: [ ios ]
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.4.app/Contents/Developer
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Verify toolchain
        run: |
          which xcodebuild
          xcodebuild -version
          echo "DEVELOPER_DIR=$DEVELOPER_DIR"
          xcode-select -p
          swift --version

      - name: Install tools
        run: |
          brew update
          brew install xcbeautify jq

      - name: Generate workspace (.swiftpm/xcode/package.xcworkspace)
        run: xed -b .

      - name: Detect scheme
        id: scheme
        run: |
          set -euo pipefail
          SCHEMES_JSON=$(xcodebuild -list -workspace .swiftpm/xcode/package.xcworkspace -json)
          PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[] | select(test("-Package$"))' | head -n1)
          if [ -z "$PKG_SCHEME" ]; then
            PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[0]')
          fi
          echo "scheme=$PKG_SCHEME" >> "$GITHUB_OUTPUT"

      - name: Run tests (iOS)
        if: matrix.platform == 'ios'
        run: |
          set -euo pipefail
          set -o pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -resultBundlePath "TestResults_ios.xcresult" \
            clean test | xcbeautify --report junit --junit-report-filename "junit-${{ matrix.platform }}.xml"

      - name: Run tests (tvOS)
        if: matrix.platform == 'tvos'
        run: |
          set -euo pipefail
          set -o pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -destination 'platform=tvOS Simulator,name=Apple TV 4K (3rd generation),OS=latest' \
            -resultBundlePath "TestResults_tvos.xcresult" \
            clean test | xcbeautify --report junit --junit-report-filename "junit-${{ matrix.platform }}.xml"

      - name: Run tests (visionOS)
        if: matrix.platform == 'visionos'
        run: |
          set -euo pipefail
          set -o pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -destination 'platform=visionOS Simulator,name=Apple Vision Pro,OS=latest' \
            -resultBundlePath "TestResults_visionos.xcresult" \
            clean test | xcbeautify --report junit --junit-report-filename "junit-${{ matrix.platform }}.xml"

      - name: Run tests (Mac Catalyst)
        if: matrix.platform == 'maccatalyst'
        run: |
          set -euo pipefail
          set -o pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -destination 'platform=macOS,variant=Mac Catalyst' \
            -resultBundlePath "TestResults_maccatalyst.xcresult" \
            clean test | xcbeautify --report junit --junit-report-filename "junit-${{ matrix.platform }}.xml"

      - name: Assert JUnit exists
        if: always()
        run: |
          ls -l "junit-${{ matrix.platform }}.xml"

      - name: Publish JUnit to Checks
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: junit-${{ matrix.platform }}.xml
          check_name: Tests (${{ matrix.platform }})
          require_tests: true

      - name: Upload .xcresult artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xcresult-${{ matrix.platform }}
          path: TestResults_${{ matrix.platform }}.xcresult
          if-no-files-found: ignore
