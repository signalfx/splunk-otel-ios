name: Lint & Tests

on:
    push:
#     branches: [ main ]
#   pull_request:
#       types: [opened, edited, reopened, synchronize]

jobs:
    lint:
    name: Lint
    runs-on: macos-15
    steps:
        - uses: actions/checkout@v4

        - uses: maxim-lobanov/setup-xcode@v1
        with:
            xcode-version: latest-stable

        - name: Install SwiftLint
        run: |
          brew update
          brew install swiftlint

        - name: SwiftLint
        run: |
            for dir in $(find . -maxdepth 1 -type d -name "Splunk*"); do
                echo "Start Linting $dir"
                (
                    cd "$dir"
                    swiftlint lint \
                        --config ../Tools/.swiftlint.yml \
                        --reporter github-actions-logging \
                        --force-exclude || {
                          code=$?
                          if [ $code -eq 1 ]; then
                            echo "No Swift files found in $dir, skipping"
                          else
                            exit $code
                          fi
                        }
                    cd ..
                )
            done

  tests:
    name: Tests
    runs-on: macos-15
    strategy:
    fail-fast: false
    matrix:
#        platform: [ ios, tvos, visionos, maccatalyst ]
        platform: [ ios ]
    env:
    DEVELOPER_DIR: /Applications/Xcode_16.4.app/Contents/Developer
    steps:
    - uses: actions/checkout@v4

    - uses: maxim-lobanov/setup-xcode@v1
        with:
        xcode-version: latest-stable

    - name: Verify toolchain
        run: |
        which xcodebuild
        xcodebuild -version
        echo "DEVELOPER_DIR=$DEVELOPER_DIR"
        xcode-select -p
        swift --version

    - name: Install tools
        run: |
        brew update
        brew install xcbeautify jq

    - name: Generate workspace (.swiftpm/xcode/package.xcworkspace)
        run: xed -b .

    - name: Detect scheme
        id: scheme
        run: |
        set -euo pipefail
        SCHEMES_JSON=$(xcodebuild -list -workspace .swiftpm/xcode/package.xcworkspace -json)
        PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[] | select(test("-Package$"))' | head -n1)
        if [ -z "$PKG_SCHEME" ]; then
            PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[0]')
        fi
        echo "scheme=$PKG_SCHEME" >> "$GITHUB_OUTPUT"

    - name: Pick latest simulator destination
        id: dest
        run: |
        set -euo pipefail
        case "${{ matrix.platform }}" in
            ios)
            DEST=$(xcrun simctl list -j devices | jq -r '
            .devices | to_entries | sort_by(.key) | reverse
                | .[].value[] | select(.isAvailable==true and (.name|test("^iPhone|^iPad")))
                | "-destination platform=iOS Simulator,id=\(.udid)"' | head -n1)
                ;;
            tvos)
            DEST=$(xcrun simctl list -j devices | jq -r '
            .devices | to_entries | sort_by(.key) | reverse
                | .[].value[] | select(.isAvailable==true and (.name|test("^Apple TV")))
                | "-destination platform=tvOS Simulator,id=\(.udid)"' | head -n1)
                ;;
            visionos)
            DEST=$(xcrun simctl list -j devices | jq -r '
            .devices | to_entries | sort_by(.key) | reverse
                | .[].value[] | select(.isAvailable==true and (.name|test("Apple Vision")))
                | "-destination platform=visionOS Simulator,id=\(.udid)"' | head -n1)
                ;;
            maccatalyst)
            DEST="-destination platform=macOS,variant=Mac Catalyst"
            ;;
        esac
        if [ -z "${DEST:-}" ]; then
            echo "No suitable simulator found for ${{ matrix.platform }}"
            xcrun simctl list devices
            exit 1
        fi
        echo "dest=$DEST" >> "$GITHUB_OUTPUT"

    - name: Run tests (${{ matrix.platform }}) and always emit JUnit
        id: test
        run: |
        set -u
        set -o pipefail
        LOG="xcodebuild-${{ matrix.platform }}.log"
        JUNIT="junit-${{ matrix.platform }}.xml"
        XCRESULT="TestResults_${{ matrix.platform }}.xcresult"

        xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            ${{ steps.dest.outputs.dest }} \
            -resultBundlePath "$XCRESULT" \
            clean test \
        2>&1 | tee "$LOG" | xcbeautify --report junit --junit-report-filename "$JUNIT"

        XCODE_STATUS=${PIPESTATUS[0]}
        echo "xcode_status=$XCODE_STATUS" >> "$GITHUB_OUTPUT"
        exit 0

    - name: Assert/print JUnit presence
        if: always()
        run: |
        ls -l "junit-${{ matrix.platform }}.xml" || echo "⚠️ JUnit not found for ${{ matrix.platform }}"

    - name: Publish JUnit to Checks
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
        report_paths: junit-${{ matrix.platform }}.xml
        check_name: Tests (${{ matrix.platform }})
        require_tests: true
        include_passed: true
        fail_on_failure: false
        detailed_summary: true

    - name: Upload .xcresult artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
        name: xcresult-${{ matrix.platform }}
        path: TestResults_${{ matrix.platform }}.xcresult
        if-no-files-found: warn

    - name: Fail job if xcodebuild failed
        if: always()
        run: |
        code="${{ steps.test.outputs.xcode_status }}"
        if [ -z "$code" ]; then
            echo "No exit code captured, assuming success"; exit 0
        fi
        if [ "$code" -ne 0 ]; then
            echo "xcodebuild failed with exit code $code"
            exit "$code"
        fi
