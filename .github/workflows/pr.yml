name: PR checks

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  validate-title:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      - name: Validate PR Title
        uses: ./.github/actions/validate-pr-title

  lint:
    name: Lint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install SwiftLint
        run: |
          brew update
          brew install swiftlint

      - name: SwiftLint
        run: |
            swiftlint lint \
                --config Tools/.swiftlint.yml \
                --reporter github-actions-logging \
                --force-exclude || {
                  code=$?
                  if [ $code -eq 1 ]; then
                    echo "No Swift files found in $dir, skipping"
                  else
                    exit $code
                  fi
                }
                

  buildable:
    name: Buildable
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [ios, tvos, visionos, macCatalyst]
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Generate workspace (.swiftpm/xcode/package.xcworkspace)
        run: xed -b .

      - name: Detect scheme
        id: scheme
        run: |
          SCHEMES_JSON=$(xcodebuild -list -workspace .swiftpm/xcode/package.xcworkspace -json)
          PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[] | select(test("-Package$"))' | head -n1)
          if [ -z "$PKG_SCHEME" ] || [ "$PKG_SCHEME" = "null" ]; then
            PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[0]')
          fi
          echo "scheme=$PKG_SCHEME" >> "$GITHUB_OUTPUT"

      - name: Resolve destination
        id: dest
        run: |
          set -euo pipefail
          PLATFORM="${{ matrix.platform }}"
          WORKSPACE=".swiftpm/xcode/package.xcworkspace"
          SCHEME="${{ steps.scheme.outputs.scheme }}"

          if [ "$PLATFORM" = "macCatalyst" ]; then
            echo "dest=platform=macOS,variant=Mac Catalyst" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RAW=$(xcodebuild -showdestinations -workspace "$WORKSPACE" -scheme "$SCHEME" -json || echo '{}')
          if [ "$PLATFORM" = "ios" ]; then
            DID=$(echo "$RAW" | jq -r '.destinations[]? | select(.platform=="iOS Simulator" and .available=="YES") | .id' | head -n1)
            if [ -z "${DID:-}" ] || [ "$DID" = "null" ]; then
              ID=$(xcrun simctl list -j devices available | jq -r '.devices[]|.[]|select(.isAvailable==true and (.name|test("iPhone|iPad"))).udid' | head -n1)
              echo "dest=platform=iOS Simulator,id=$ID" >> "$GITHUB_OUTPUT"
            else
              echo "dest=id=$DID" >> "$GITHUB_OUTPUT"
            fi
          elif [ "$PLATFORM" = "tvos" ]; then
            DID=$(echo "$RAW" | jq -r '.destinations[]? | select(.platform=="tvOS Simulator" and .available=="YES") | .id' | head -n1)
            if [ -z "${DID:-}" ] || [ "$DID" = "null" ]; then
              ID=$(xcrun simctl list -j devices available | jq -r '.devices[]|.[]|select(.isAvailable==true and (.name|test("Apple TV"))).udid' | head -n1)
              echo "dest=platform=tvOS Simulator,id=$ID" >> "$GITHUB_OUTPUT"
            else
              echo "dest=id=$DID" >> "$GITHUB_OUTPUT"
            fi
          elif [ "$PLATFORM" = "visionos" ]; then
            DID=$(echo "$RAW" | jq -r '.destinations[]? | select(.platform=="visionOS Simulator" and .available=="YES") | .id' | head -n1)
            if [ -z "${DID:-}" ] || [ "$DID" = "null" ]; then
              ID=$(xcrun simctl list -j devices available | jq -r '.devices[]|.[]|select(.isAvailable==true and (.name|test("Apple Vision"))).udid' | head -n1)
              echo "dest=platform=visionOS Simulator,id=$ID" >> "$GITHUB_OUTPUT"
            else
              echo "dest=id=$DID" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Build (${{ matrix.platform }})
        run: |
          set -euo pipefail
          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -destination "${{ matrix.destination }}" \
            -configuration Debug \
            -skipPackagePluginValidation \
            clean build

  tests:
    name: Tests
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [ios]
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Generate workspace (.swiftpm/xcode/package.xcworkspace)
        run: xed -b .

      - name: Detect scheme
        id: scheme
        run: |
          SCHEMES_JSON=$(xcodebuild -list -workspace .swiftpm/xcode/package.xcworkspace -json)
          PKG_SCHEME=$(echo "$SCHEMES_JSON" | jq -r '.workspace.schemes[0]')
          echo "scheme=$PKG_SCHEME" >> "$GITHUB_OUTPUT"

      - name: Resolve destination
        id: dest
        run: |
          set -euo pipefail
          WORKSPACE=".swiftpm/xcode/package.xcworkspace"
          SCHEME="${{ steps.scheme.outputs.scheme }}"
          RAW=$(xcodebuild -showdestinations -workspace "$WORKSPACE" -scheme "$SCHEME" -json || echo '{}')
          DID=$(echo "$RAW" | jq -r '.destinations[]? | select(.platform=="iOS Simulator" and .available=="YES") | .id' | head -n1)
          if [ -z "${DID:-}" ] || [ "$DID" = "null" ]; then
            ID=$(xcrun simctl list -j devices available | jq -r '.devices[]|.[]|select(.isAvailable==true and (.name|test("iPhone|iPad"))).udid' | head -n1)
            echo "dest=platform=iOS Simulator,id=$ID" >> "$GITHUB_OUTPUT"
          else
            echo "dest=id=$DID" >> "$GITHUB_OUTPUT"
          fi

      - name: Run tests (${{ matrix.platform }})
        id: test
        run: |
          OUT_DIR="reports"; mkdir -p "$OUT_DIR"
          LOG="$OUT_DIR/xcodebuild-${{ matrix.platform }}.log"
          JUNIT="$OUT_DIR/junit-${{ matrix.platform }}.xml"
          XCRESULT="TestResults_${{ matrix.platform }}.xcresult"

          xcodebuild \
            -workspace .swiftpm/xcode/package.xcworkspace \
            -scheme "${{ steps.scheme.outputs.scheme }}" \
            -destination "${{ matrix.destination }}" \
            -resultBundlePath "$XCRESULT" \
            clean test \
          2>&1 | tee "$LOG" | xcbeautify \
                 --report junit \
                 --junit-report-filename "$(basename "$JUNIT")" \
                 --report-path "$OUT_DIR"

          XCODE_STATUS=${PIPESTATUS[0]}
          echo "xcode_status=$XCODE_STATUS" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Publish JUnit to Checks
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: reports/junit-${{ matrix.platform }}.xml
          check_name: Tests (${{ matrix.platform }})
          require_tests: true
          include_passed: false
          fail_on_failure: false
          detailed_summary: true

      - name: Upload .xcresult artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: testresults-${{ matrix.platform }}.xcresult
          path: TestResults_${{ matrix.platform }}.xcresult
          if-no-files-found: warn

      - name: Fail job if xcodebuild failed
        if: always()
        run: |
          code="${{ steps.test.outputs.xcode_status }}"
          if [ -z "$code" ]; then exit 0; fi
          if [ "$code" -ne 0 ]; then exit "$code"; fi
